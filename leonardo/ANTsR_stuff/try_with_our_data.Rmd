---
title: "ANTsR try with our data"
output: html_notebook
---


```{r}
library(ANTsR)
library(dplyr)
```

## Define functions for plotting
```{r}

# Only one image
antsplot.single <- function(image, axis=1, step=10){
  invisible(
    plot(
      image,
      axis=axis,
      # slices=seq(90, 160, by=step),
      doCropping = F
    )  
  )
}


# Simple overlay with alpha
antsplot.olay <- function(bg, olay, axis=1, alpha=0.5){
  invisible(
    plot(
      bg, olay,
      axis=axis,
      color.overlay='red',
      doCropping = T,
      alpha=alpha,
      window.overlay = quantile(olay, c(0.72,1))
    )  
  )
}


# Overlay canny borders
antsplot.canny <- function(bg, olay, axis=1, alpha=1, step=10){
  canned_olay = iMath(olay, "Canny", 20,20,20)
  invisible(
    plot(
      bg, canned_olay,
      axis=axis,
      # slices=seq(90, 160, by=step),
      color.overlay='red',
      doCropping = F,
      alpha=alpha
    )  
  )
}

```


## Load the data
```{r}
bd='/data00/leonardo/layers/regdata/'

full_filename <- paste0(bd,'sub_02/ses_01/anat/full_T1w_bc_brain.nii.gz')
part_filename <- paste0(bd,'sub_02/ses_01/anat/part_T1w_bc_brain.nii.gz')
fmri_filename <- paste0(bd,'sub_02/ses_01/func/task_1_run_1_mean_bc_brain.nii.gz')

```


```{r}
full <- antsImageRead(full_filename)
part <- antsImageRead(part_filename)
fmri <- antsImageRead(fmri_filename)

antsplot.single(full, axis = 1)
antsplot.single(part, axis = 1)
antsplot.single(fmri, axis = 1)

antsplot.canny(fmri,part,axis = 1)

antsplot.olay(fmri,part)

antsplot.single(full)

```

## Register fmri to part
```{r}

fmri2part <- antsRegistration(
  fixed = part,
  moving = fmri,
  typeofTransform = "Affine",   # Affine or SyNBoldAff
  verbose = F
)

antsplot.canny(fmri2part$warpedmovout, part)

fmri2part.filename <-  gsub(".nii.gz", "_reg2part.nii.gz", fmri_filename)

antsImageWrite(fmri2part$warpedmovout, fmri2part.filename)


```


## Register part to full
```{r}

part2full <- antsRegistration(
  fixed = full,
  moving = part,
  typeofTransform = "Affine",
  verbose = F
)

antsplot.canny(part2full$warpedmovout, full)

part2full.filename <-  gsub(".nii.gz", "_reg2full.nii.gz", part_filename)
antsImageWrite(part2full$warpedmovout, part2full.filename)

```



## Register part to full with initial translation
```{r}
part2full_translation <- antsRegistration(
  fixed = full,
  moving = part,
  typeofTransform = "Translation",
  verbose = F
)

antsplot.canny(part2full_translation$warpedmovout, full)


part2full <- antsRegistration(
  fixed = full,
  moving = part,
  typeofTransform = "SyN",
  initialTransform = part2full_translation$fwd,
  verbose = F
)

antsplot.canny(part2full$warpedmovout, full)

part2full.filename <-  gsub(".nii.gz", "_reg2full.nii.gz", part_filename)
antsImageWrite(part2full$warpedmovout, part2full.filename)

```


## Register fmri to full with initial translation
```{r}
fmri2full_translation <- antsRegistration(
  fixed = full,
  moving = fmri,
  typeofTransform = "Translation",
  verbose = F
)

antsplot.canny(fmri2full_translation$warpedmovout, full)


fmri2full <- antsRegistration(
  fixed = full,
  moving = fmri,
  typeofTransform = "SyNBoldAff",
  initialTransform = fmri2full_translation$fwd,
  verbose = F
)

antsplot.canny(fmri2full$warpedmovout, full)

fmri2full.filename <-  gsub(".nii.gz", "_reg2full.nii.gz", fmri_filename)
antsImageWrite(fmri2full$warpedmovout, fmri2full.filename)

```










## Register func to part_anat
```{r}
Func_2_Panat <- antsRegistration(
  fixed = part_anat,
  moving = func,
  typeofTransform = "SyNBoldAff",
  verbose = F
)

antsplot.canny(
  Func_2_Panat$warpedmovout, part_anat
)

Func_2_Panat.filename <-  gsub(".nii.gz", "_reg2partanat.nii.gz", func_filename)

antsImageWrite(Func_2_Panat$warpedmovout, Func_2_Panat.filename)



canned_olay = iMath(func, "Canny", 20,20,20)

antsplot.single(part_anat)

gdilated <- iMath(full_anat, "GD", 2)

antsplot.canny(full_anat, gdilated - full_anat)



antsplot.canny <- function(bg, olay, axis=1, alpha=1, step=10){
  canned_olay = iMath(olay, "Canny", 20,20,20)
  invisible(
    plot(
      bg, canned_olay,
      axis=axis,
      # slices=seq(90, 160, by=step),
      color.overlay='red',
      doCropping = F,
      alpha=alpha
    )  
  )
}





```


```{r}

denoised <- iMath(part, "PeronaMalik", 20, 0.5)

antsplot.single(part)
antsplot.single(denoised)
antsplot.single(part - denoised)

grad <- iMath(denoised, "Grad", 1, 1)
antsplot.single(grad)


canned_olay = iMath(part_anat, "Canny", 10,10,10)
canned_olay_smooth = smoothImage(canned_olay, 1)

antsplot.olay(denoised, canned_olay, alpha = 1)

antsplot.single(
  smoothImage(part_anat,0.5)
)

part_anat %>% 
  smoothImage(1) %>%
  iMath("PeronaMalik", 20, 05) %>%
  iMath("Canny", 5,5,5) %>% 
  antsplot.single()



```

# Try ANTsRNet brain extraction!
```{r}

T1 <- antsImageRead(paste0(bd,'sub_02/ses_01/anat/full_T1w.nii.gz'))

MNI <- antsImageRead('/home/cerliani/nilearn_data/icbm152_2009/mni_icbm152_nlin_sym_09a/mni_icbm152_t1_tal_nlin_sym_09a.nii.gz')

part_T1 <- antsImageRead(paste0(bd,'sub_02/ses_01/anat/part_T1w.nii.gz'))

antsplot.single(part_T1)

stripped <- brainExtraction(
  part_T1,
  modality = "t1"
)


stripped

antsplot.single(stripped)





fmri %>% iMath("Neg")

```


# Question to the forum

I work with (f)MRI images, and I am trying to understand how to build a composite transformation fmri --> T1 --> MNI and its inverse.

I am sorry in advance for the size of this post. However I think you will be able to answer very quickly. I tried to make the example in clearest possible way.

I saw [this](http://htmlpreview.github.io/?https://github.com/stnava/fMRIANTs/blob/master/ANTsRfMRI_FAQ.html) Rmd notebook but **I am puzzled by the order of transformation in the composite**. 

The following is an adapted version of the cells in the Rmd notebook which detail the steps of the transformation:

```{r}

# t1 --> MNI
t1_to_MNI <- antsRegistration(
  fixed = MNI, moving = t1,
  typeofTransform = "SyN"
)

# t1 --> fmri
t1_to_fmri <- antsRegistration(
  fixed = fmri, moving = t1,
  typeofTransform="SyNBold"
)

# list of transformation to map fmri --> T1 --> MNI
# This is what I do not understand
fulltx<-c(
  t1_to_MNI$fwdtransforms[1],   # warp
  t1_to_MNI$fwdtransforms[2],   # aff
  t1_to_fmri$invtransforms[1],  # aff
  t1_to_fmri$invtransforms[2]   # warp
)

# map fmri to MNI
fmri_to_MNI_image <- antsApplyTransforms(
  fixed = MNI,
  moving = fmri, transformlist = fulltx,
  whichtoinvert = c(F,F,T,F)
)

```

It therefore seems that when applying a composite registration fmri --> t1 --> MNI, the order of the transformation should be reversed, that is first `[t1 --> MNI]` and then `[fmri --> t1]` (in this case `(inv)[fmri --> t1]`).

**Is this a general rule? If I want to compose `A_to_B` (fmri -> t1) and `B_to_C` (t1 -> MNI) to transform `A -> C` (fmri -> MNI) I need to order the transformations as `c(B_to_C, A_to_B)`?**

This appears to be the case also in the composite T2 -> T1 -> T1template [here](https://github.com/ANTsX/ANTs/wiki/Forward-and-inverse-warps-for-warping-images,-pointsets-and-Jacobians), but instead when concatenating _inverse_ transformation it looks like the order remains the "intuitive" one. 

For instance in [this python notebook](https://github.com/ANTsX/ANTsPy/blob/master/tutorials/concatenateRegistrations.ipynb) (snippet below), to go from `img3 -> img2 -> img1` you combine the inverse of `reg12` and `reg23` in the "expected" order: first `reg23[inv]` and `reg12[inv]`

```{python}
reg12 = ants.registration( img1, img2, 'SyN', reg_iterations = [100,100,20] )
reg23 = ants.registration( img2, img3, 'SyN', reg_iterations = [100,100,20] )

mytx = reg23[ 'invtransforms'] + reg12[ 'invtransforms']

mywarpedimage = ants.apply_transforms( fixed = img3, 
                                       moving = seg1['segmentation'] , 
                                       transformlist = mytx, 
                                       interpolator  = 'nearestNeighbor', 
                                       whichtoinvert = [True,False,True,False])
```


Thank you very much for your help!











