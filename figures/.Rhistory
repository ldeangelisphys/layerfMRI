library(DT)
options(digits = 3)
# -------------------------- User-defined parameters --------------------------
nbin <- 6     # 3-10; check also the filenames in this dir
# -------------------------- End of User-defined parameters -------------------
# read the table with the names of JU ROI and remove WM regions
julabels <- read.csv("labels_juelich.csv", stringsAsFactors = F) %>%
mutate(name = str_replace(name,"['-/]","")) %>%    # get rid of special chars
mutate(numba = index + 1) %>%
filter(grepl("GM", name)) %>%
select(-index)
results_filename <- paste0(
getwd(),
"/",
"M_OR_S_JU_time_courses_thr100_bin",
nbin,
"_isc.csv"
)
ISC_estimates <- read.csv(results_filename,stringsAsFactors = F)
# Show table with the ISC parameter estimates
ISC_estimates %>%
select(-c(X,tc_concatenated)) %>%
inner_join(julabels, by=c("JU"="numba")) %>%
rename(JU_region = name) %>%
select(-JU) %>%
relocate(JU_region) %>%
datatable(
extensions = 'Buttons', options = list(
dom = 'Bfrtip',
buttons = c('csv', 'excel')
)
) %>%
formatRound(columns=c('isc'), digits=3)
ISC_estimates_nest <- ISC_estimates %>%
select(-c(tc_concatenated, X)) %>%
inner_join(julabels, by=c("JU"="numba")) %>%
group_by(JU,D_bins) %>%
nest()
# Function to test Motion > Scrambled in every nested df
# It's defined outside so that it can be easily modified to be something
# other than t.test
compare_contrasts <- function(df) {
t.test(df %>% filter(contrast == "Motion") %>% select(isc) %>% pull(),
df %>% filter(contrast == "Scrambled") %>% select(isc) %>% pull(),
paired = TRUE)
}
# Carry out the comparison Motion > Scrambled for each D_bin in each JU ROI
ttest_res <- ISC_estimates_nest %>%
mutate(
ttest = map(data, compare_contrasts)
)
library(broom)
# # Use the line below to check which estimates to extract
# ttest_res$ttest[[1]] %>% glance()
# Extract the parameters of interest (T,p)
ttest_res <- ttest_res %>%
mutate(
glance = ttest %>% map(glance),
T = glance %>% map_dbl("statistic"),
p = glance %>% map_dbl("p.value")
)
# Add column of names for JU ROIs
res <- ttest_res %>%
select(D_bins, JU, T, p, data) %>%
inner_join(. , julabels, by = c("JU"="numba")) %>%
mutate(name = str_replace_all(name, "_", " "))
# Apply fdr correction per ROI
res <- res %>%
group_by(JU) %>%
mutate(
pcorr = p.adjust(p, "fdr"),
) %>%
mutate(pcorr_sig = ifelse(pcorr <= 0.05, D_bins, NA))  # to print asterisk on sig p bins
# Show a table of sig ROIs/bins
title = "Significant differences uncorrected and corrected ( $q(FDR) = 0.05$ ) in Motion > Scrambled"
res %>%
select(-data) %>%
ungroup() %>%
filter(!is.na(pcorr_sig)) %>%
select(-c(JU,pcorr_sig)) %>%
relocate(pcorr, .after = p) %>%
kbl(caption =  title) %>%
kable_styling(c("condensed"))
# Plot the effect size (actually T stat) for the comparison Motion > Scrambled
res %>%
mutate(D_bins = as.numeric(D_bins)) %>%
ggplot( aes(x = D_bins, y = T, fill = D_bins ) ) +
# scale_fill_gradient(low = "orange", high = "blue", na.value = NA) +
scale_fill_gradient2_tableau() +
geom_bar(stat = "identity", position = position_identity()) +
geom_text( aes(x = pcorr_sig, y = T + 0.1, label = "*"), fontface = "bold", size=10, na.rm = T ) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
# coord_cartesian(ylim = c(min(res$T), max(res$T) + 0.2)) +
theme_minimal() +  # also theme_bw and theme_few
labs(
title = "T statistic at each cortical depth for Motion > Scrambled",
subtitle = "Comparison of the ISC parameter estimates in each bin in either contrast"
) +
ylab("Scrambled <   > Motion") + xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial")+
theme(
strip.text.x = element_text(size = 12), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res$T) - 0.2, max(res$T) + 0.2))
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
res_descriptives <- res %>%
select(-c(T,p,pcorr,name)) %>%
unnest(data) %>%
mutate(name = str_replace_all(name, "_", " ")) %>%
group_by(JU, name, D_bins, contrast, pcorr_sig) %>%
summarise(
meanZ = mean(isc, na.rm = T),
sterrZ = sterr(isc),
.groups = "drop"
)
res_descriptives %>%
mutate(pcorr_sig = ifelse(contrast == "Motion", pcorr_sig, NA)) %>%  # to plot only one asterisk
ggplot( aes(x = D_bins, y = meanZ, fill = contrast) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
geom_text(
aes(x = pcorr_sig, y = meanZ + 0, label = "*"), fontface = "bold", size=10, na.rm = T
) +
geom_linerange(aes(ymin = meanZ - sterrZ, ymax = meanZ + sterrZ, color=contrast), alpha = 0.5) +
# coord_cartesian(ylim = c(zthr, max(res_descriptives$meanZ) + 0.2)) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean ISC parameter estimates for each Depth bin in each Juelich region across participants"
) +
ylab("Mean ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip()
# function to calculate the mean of Motion - Scrambled across participants
get_M_minus_S <- function(df) {
df %>%
pivot_wider(names_from = contrast, values_from = isc) %>%
mutate(M_minus_S = Motion - Scrambled) %>%
select(M_minus_S)
}
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
# prepare the Motion - Scrambled for each sub, its mean and sderr
res2plot <- res %>%
mutate(
diff_MS = map(data, get_M_minus_S),
) %>%
select(D_bins, JU, diff_MS,name,pcorr_sig) %>%
unnest(diff_MS) %>%
group_by(D_bins, JU) %>%
mutate(
diff_mean = mean(M_minus_S, na.rm = T),
diff_sterr = sterr(M_minus_S)
)
# # pipe the following to have a clearer view of res2plot
# group_by(D_bins, JU, diff_mean,diff_sterr,name,pcorr_sig) %>%
# nest()
# plot mean difference Motion - Scrambled, and its variability across subs
res2plot %>%
# unnest(data) %>%
ggplot( aes(x = D_bins, y = diff_mean, fill = D_bins) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
# geom_linerange(
#   aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
#   color="red", alpha = 0.5
# ) +
scale_fill_gradient2_tableau() +
geom_point(
aes(x = pcorr_sig, y = M_minus_S, fill = D_bins),
shape = 21, size = 2,
na.rm = T # to suppress the warning due to plotting only pcorr_sig cols
) +
geom_linerange(
aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
color="red", alpha = 0.5
) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean Motion - Scrambled ISC parameter estimates for each Depth bin in each Juelich region across participants",
subtitle = "Individual participants are plotted only for bins which show a (corrected) sig difference between Motion and Scrambled"
) +
ylab("Mean Motion - Scrambled ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res2plot$diff_mean) - 0.05, max(res2plot$diff_mean) + 0.05))
# Plot the effect size (actually T stat) for the comparison Motion > Scrambled
fig <- res %>%
mutate(D_bins = as.numeric(D_bins)) %>%
ggplot( aes(x = D_bins, y = T, fill = D_bins ) ) +
# scale_fill_gradient(low = "orange", high = "blue", na.value = NA) +
scale_fill_gradient2_tableau() +
geom_bar(stat = "identity", position = position_identity()) +
geom_text( aes(x = pcorr_sig, y = T + 0.1, label = "*"), fontface = "bold", size=10, na.rm = T ) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
# coord_cartesian(ylim = c(min(res$T), max(res$T) + 0.2)) +
theme_minimal() +  # also theme_bw and theme_few
labs(
title = "T statistic at each cortical depth for Motion > Scrambled",
subtitle = "Comparison of the ISC parameter estimates in each bin in either contrast"
) +
ylab("Scrambled <   > Motion") + xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial")+
theme(
strip.text.x = element_text(size = 12), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res$T) - 0.2, max(res$T) + 0.2))
fig
bd
pdfdir
bd="/Users/leonardo/GoogleDrive/LAYER_fMRI/__PAPER__/figures/"
thisfigdir="fig_3_results_ISC2/"
datadir=paste0(bd,thisfigdir,'/Data/')
pdfdir=paste0(bd,thisfigdir,'/FigureElementsPDF/')
knitr::opts_knit$set(root.dir = datadir)
getwd()
pdfdir
fig
# Plot the effect size (actually T stat) for the comparison Motion > Scrambled
fig <- res %>%
mutate(D_bins = as.numeric(D_bins)) %>%
ggplot( aes(x = D_bins, y = T, fill = D_bins ) ) +
# scale_fill_gradient(low = "orange", high = "blue", na.value = NA) +
scale_fill_gradient2_tableau() +
geom_bar(stat = "identity", position = position_identity()) +
geom_text( aes(x = pcorr_sig, y = T + 0.1, label = "*"), fontface = "bold", size=10, na.rm = T ) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
# coord_cartesian(ylim = c(min(res$T), max(res$T) + 0.2)) +
theme_minimal() +  # also theme_bw and theme_few
labs(
title = "T statistic at each cortical depth for Motion > Scrambled",
subtitle = "Comparison of the ISC parameter estimates in each bin in either contrast"
) +
ylab("Scrambled <   > Motion") + xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial")+
theme(
strip.text.x = element_text(size = 12), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res$T) - 0.2, max(res$T) + 0.2))
fig
pdf(paste0(pdfdir,'Tstat_ISC.pdf'))
fig
dev.off()
# Plot the effect size (actually T stat) for the comparison Motion > Scrambled
fig <- res %>%
mutate(D_bins = as.numeric(D_bins)) %>%
ggplot( aes(x = D_bins, y = T, fill = D_bins ) ) +
# scale_fill_gradient(low = "orange", high = "blue", na.value = NA) +
scale_fill_gradient2_tableau() +
geom_bar(stat = "identity", position = position_identity()) +
geom_text( aes(x = pcorr_sig, y = T + 0.1, label = "*"), fontface = "bold", size=10, na.rm = T ) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
# coord_cartesian(ylim = c(min(res$T), max(res$T) + 0.2)) +
theme_minimal() +  # also theme_bw and theme_few
labs(
title = "T statistic at each cortical depth for Motion > Scrambled",
subtitle = "Comparison of the ISC parameter estimates in each bin in either contrast"
) +
ylab("Scrambled <   > Motion") + xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial")+
theme(
strip.text.x = element_text(size = 12), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res$T) - 0.2, max(res$T) + 0.2))
# fig
pdf(paste0(pdfdir,'Tstat_ISC.pdf'))
fig
dev.off()
# Plot the effect size (actually T stat) for the comparison Motion > Scrambled
fig <- res %>%
mutate(D_bins = as.numeric(D_bins)) %>%
ggplot( aes(x = D_bins, y = T, fill = D_bins ) ) +
# scale_fill_gradient(low = "orange", high = "blue", na.value = NA) +
scale_fill_gradient2_tableau() +
geom_bar(stat = "identity", position = position_identity()) +
geom_text( aes(x = pcorr_sig, y = T + 0.1, label = "*"), fontface = "bold", size=10, na.rm = T ) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
# coord_cartesian(ylim = c(min(res$T), max(res$T) + 0.2)) +
theme_minimal() +  # also theme_bw and theme_few
labs(
title = "T statistic at each cortical depth for Motion > Scrambled",
subtitle = "Comparison of the ISC parameter estimates in each bin in either contrast"
) +
ylab("Scrambled <   > Motion") + xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial")+
theme(
strip.text.x = element_text(size = 12), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res$T) - 0.2, max(res$T) + 0.2))
fig
pdf(paste0(pdfdir,'Tstat_ISC.pdf'))
fig
dev.off()
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
res_descriptives <- res %>%
select(-c(T,p,pcorr,name)) %>%
unnest(data) %>%
mutate(name = str_replace_all(name, "_", " ")) %>%
group_by(JU, name, D_bins, contrast, pcorr_sig) %>%
summarise(
meanZ = mean(isc, na.rm = T),
sterrZ = sterr(isc),
.groups = "drop"
)
res_descriptives %>%
mutate(pcorr_sig = ifelse(contrast == "Motion", pcorr_sig, NA)) %>%  # to plot only one asterisk
ggplot( aes(x = D_bins, y = meanZ, fill = contrast) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
geom_text(
aes(x = pcorr_sig, y = meanZ + 0, label = "*"), fontface = "bold", size=10, na.rm = T
) +
geom_linerange(aes(ymin = meanZ - sterrZ, ymax = meanZ + sterrZ, color=contrast), alpha = 0.5) +
# coord_cartesian(ylim = c(zthr, max(res_descriptives$meanZ) + 0.2)) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean ISC parameter estimates for each Depth bin in each Juelich region across participants"
) +
ylab("Mean ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip()
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
res_descriptives <- res %>%
select(-c(T,p,pcorr,name)) %>%
unnest(data) %>%
mutate(name = str_replace_all(name, "_", " ")) %>%
group_by(JU, name, D_bins, contrast, pcorr_sig) %>%
summarise(
meanZ = mean(isc, na.rm = T),
sterrZ = sterr(isc),
.groups = "drop"
)
fig <- res_descriptives %>%
mutate(pcorr_sig = ifelse(contrast == "Motion", pcorr_sig, NA)) %>%  # to plot only one asterisk
ggplot( aes(x = D_bins, y = meanZ, fill = contrast) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
geom_text(
aes(x = pcorr_sig, y = meanZ + 0, label = "*"), fontface = "bold", size=10, na.rm = T
) +
geom_linerange(aes(ymin = meanZ - sterrZ, ymax = meanZ + sterrZ, color=contrast), alpha = 0.5) +
# coord_cartesian(ylim = c(zthr, max(res_descriptives$meanZ) + 0.2)) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean ISC parameter estimates for each Depth bin in each Juelich region across participants"
) +
ylab("Mean ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip()
fig
# save the pdf of the figure
pdf(paste0(pdfdir,'descriptives_ISC.pdf'))
fig
dev.off()
# function to calculate the mean of Motion - Scrambled across participants
get_M_minus_S <- function(df) {
df %>%
pivot_wider(names_from = contrast, values_from = isc) %>%
mutate(M_minus_S = Motion - Scrambled) %>%
select(M_minus_S)
}
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
# prepare the Motion - Scrambled for each sub, its mean and sderr
res2plot <- res %>%
mutate(
diff_MS = map(data, get_M_minus_S),
) %>%
select(D_bins, JU, diff_MS,name,pcorr_sig) %>%
unnest(diff_MS) %>%
group_by(D_bins, JU) %>%
mutate(
diff_mean = mean(M_minus_S, na.rm = T),
diff_sterr = sterr(M_minus_S)
)
# # pipe the following to have a clearer view of res2plot
# group_by(D_bins, JU, diff_mean,diff_sterr,name,pcorr_sig) %>%
# nest()
# plot mean difference Motion - Scrambled, and its variability across subs
res2plot %>%
# unnest(data) %>%
ggplot( aes(x = D_bins, y = diff_mean, fill = D_bins) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
# geom_linerange(
#   aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
#   color="red", alpha = 0.5
# ) +
scale_fill_gradient2_tableau() +
geom_point(
aes(x = pcorr_sig, y = M_minus_S, fill = D_bins),
shape = 21, size = 2,
na.rm = T # to suppress the warning due to plotting only pcorr_sig cols
) +
geom_linerange(
aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
color="red", alpha = 0.5
) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean Motion - Scrambled ISC parameter estimates for each Depth bin in each Juelich region across participants",
subtitle = "Individual participants are plotted only for bins which show a (corrected) sig difference between Motion and Scrambled"
) +
ylab("Mean Motion - Scrambled ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res2plot$diff_mean) - 0.05, max(res2plot$diff_mean) + 0.05))
# function to calculate the mean of Motion - Scrambled across participants
get_M_minus_S <- function(df) {
df %>%
pivot_wider(names_from = contrast, values_from = isc) %>%
mutate(M_minus_S = Motion - Scrambled) %>%
select(M_minus_S)
}
# function to calculate standard error after removing NAs
sterr <- function(x) {
x <- x[!is.na(x)]
sd(x)/sqrt(length(x))
}
# prepare the Motion - Scrambled for each sub, its mean and sderr
res2plot <- res %>%
mutate(
diff_MS = map(data, get_M_minus_S),
) %>%
select(D_bins, JU, diff_MS,name,pcorr_sig) %>%
unnest(diff_MS) %>%
group_by(D_bins, JU) %>%
mutate(
diff_mean = mean(M_minus_S, na.rm = T),
diff_sterr = sterr(M_minus_S)
)
# # pipe the following to have a clearer view of res2plot
# group_by(D_bins, JU, diff_mean,diff_sterr,name,pcorr_sig) %>%
# nest()
# plot mean difference Motion - Scrambled, and its variability across subs
fig <- res2plot %>%
# unnest(data) %>%
ggplot( aes(x = D_bins, y = diff_mean, fill = D_bins) ) +
geom_bar(stat = "identity", position = position_identity(), alpha = 0.6) +
# geom_linerange(
#   aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
#   color="red", alpha = 0.5
# ) +
scale_fill_gradient2_tableau() +
geom_point(
aes(x = pcorr_sig, y = M_minus_S, fill = D_bins),
shape = 21, size = 2,
na.rm = T # to suppress the warning due to plotting only pcorr_sig cols
) +
geom_linerange(
aes(ymin = diff_mean - diff_sterr, ymax = diff_mean + diff_sterr),
color="red", alpha = 0.5
) +
facet_wrap(~ name, scales = "free", labeller = label_wrap_gen(width=22)) +
theme_minimal() +
labs(
title = "Mean Motion - Scrambled ISC parameter estimates for each Depth bin in each Juelich region across participants",
subtitle = "Individual participants are plotted only for bins which show a (corrected) sig difference between Motion and Scrambled"
) +
ylab("Mean Motion - Scrambled ISC estimate across participants") +
xlab("Cortical Depth bins :  1 = WM/GM border, 6 = pial") +
theme(
strip.text.x = element_text(size = 11), # increase size of title for each subplot
panel.spacing.y = unit(3, "lines")      # increase space between facets
) +
coord_flip(ylim = c(min(res2plot$diff_mean) - 0.05, max(res2plot$diff_mean) + 0.05))
fig
# save the pdf of the figure
pdf(paste0(pdfdir,'intersubject_variability_ISC.pdf'))
fig
dev.off()
bd="/Users/leonardo/GoogleDrive/LAYER_fMRI/__PAPER__/figures/"
thisfigdir="fig_4_ISFC_matrices/"
datadir=paste0(bd,thisfigdir,'/Data/')
pdfdir=paste0(bd,thisfigdir,'/FigureElementsPDF/')
knitr::opts_knit$set(root.dir = datadir)
getwd()
