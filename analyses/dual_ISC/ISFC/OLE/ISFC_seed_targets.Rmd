---
title: "ISFC_results"
output:
  html_document:
    code_folding: hide
---

## Important note
The visualization requires building an nbin-by-(nbin x 3) matrix where the first
matrix on the left is actually the matrix of autoconnections. While these are 
zeroed before visualization - as we are interested only in pairwise connectivity -
we still need to include it since in the definition of nodes, labels, sources 
and target, the first 6 (e.g for nbin=6) are actually the seeds.

This is the simplest method to solve the issue. Otherwise we would have to manually
add them to each one of the required vectors (nodes, labels, sources, targets).


## plot ISFC matrix
```{r, message=F}

library(tidyverse)
library(plot.matrix)
library(plotly)
library(RColorBrewer)

datadir <- paste0(getwd(),"/results_lorenzo")

nbin <- 6

PF_PF <- read.table(paste0(datadir,"/ISFC_Motion-Scrambled_PFt-PFt_thr200_bin6.txt"), header = F, sep=" ") %>% as.matrix()

PF_BA6 <- read.table(paste0(datadir,"/ISFC_Motion-Scrambled_PFt-BA6_thr200_bin6.txt"), header = F, sep=" ") %>% as.matrix()

PF_BA44 <- read.table(paste0(datadir,"/ISFC_Motion-Scrambled_PFt-BA44_thr200_bin6.txt"), header = F, sep=" ") %>% as.matrix()


PF_names = map(1:nbin, ~ paste0("PF_",.x))
BA6_names = map(1:nbin, ~ paste0("BA6_",.x))
BA44_names = map(1:nbin, ~ paste0("BA44_",.x))

rownames(PF_PF) <- PF_names
colnames(PF_PF) <- PF_names
colnames(PF_BA6) <- BA6_names
colnames(PF_BA44) <- BA44_names

CC <- cbind(PF_PF, PF_BA6, PF_BA44)


# zero the seed-to-seed correlation
CC[1:nbin,1:nbin] <- 0

CC %>% plot(asp=T, digits = 2, cex=0.5, col = brewer.pal(9,"Reds"))


```



## sankey in colors
```{r}


zthr = 0
idx <- which(CC > zthr, arr.ind = T)

source <- idx[,1] - 1
target <- idx[,2] - 1

nbin <- nrow(CC)


# Prepare color palettes

# library(wesanderson)
# FANTASIA <- wes_palette("Zissou1", 6, type = "continuous") 
WES <- c("#78B7C5","#78B7C5", "#E1AF00","#E1AF00", "#F21A00","#F21A00")
  
REDS <- colorRampPalette(c(brewer.pal(5,"Reds")[2],brewer.pal(5,"Reds")[5]))
GREENS <- colorRampPalette(c(brewer.pal(5,"Greens")[2],brewer.pal(5,"Greens")[5]))
BLUES <- colorRampPalette(c(brewer.pal(5,"Blues")[2],brewer.pal(5,"Blues")[5]))


# prepare link_colors by generating a named character that will be used as a lookup
# https://www.infoworld.com/article/3323006/do-more-with-r-quick-lookup-tables-using-named-vectors.html
# link_colors_lookup <- brewer.pal(dim(CC)[1],"Reds")
link_colors_lookup <- WES
names(link_colors_lookup) <- rownames(CC)
link_colors <- map_chr(names(source), ~ link_colors_lookup[.x] %>% unname() %>% toRGB(alpha = 0.3))


x_pos <- c(rep(0,nbin),rep(1,nbin),rep(2,nbin))
y_pos <- rep(seq(1:nbin),3)


fig <- plot_ly(
  type = "sankey",
  domain = list(
      x =  c(0,1),
      y =  c(0,1)
    ),
  arrangement = "snap", hoverinfo = "skip", 
  textfont = list(family = "Arial"),
  orientation = "h",
  node = list(
    label = colnames(CC),
    x = x_pos/max(x_pos),
    # y = y_pos/max(y_pos),
    color = c(WES, WES, WES),
    pad = 5,
    thickness = 20
  ),
  link = list(
    source = source,
    target = target,
    value = CC[idx],
    color = link_colors
  )
)

fig

```















